name: Fear & Greed Bot

on:
  # Ch·∫°y theo l·ªãch (4 l·∫ßn/ng√†y)
  schedule:
    - cron: '0 1,5,9,13 * * *'  # 8h, 12h, 16h, 20h (UTC+7)
  
  # Cho ph√©p ch·∫°y th·ªß c√¥ng
  workflow_dispatch:
  
  # Ch·∫°y khi push code (ƒë·ªÉ test)
  push:
    branches: [ main ]

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v3
    
    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: üîç Debug secrets (chi ti·∫øt)
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        OWNER_CHAT_ID: ${{ secrets.OWNER_CHAT_ID }}
        GROUP_CHAT_ID: ${{ secrets.GROUP_CHAT_ID }}
      run: python debug_secrets.py
    
    - name: üìä Run report and send to Telegram
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        OWNER_CHAT_ID: ${{ secrets.OWNER_CHAT_ID }}
        GROUP_CHAT_ID: ${{ secrets.GROUP_CHAT_ID }}
      run: |
        python -c "
        import os
        import asyncio
        from datetime import datetime
        from telegram import Bot
        from fear_greed_dashboard import FearGreedDashboard
        
        async def send_report():
            # L·∫•y bi·∫øn m√¥i tr∆∞·ªùng
            bot_token = os.environ.get('TELEGRAM_BOT_TOKEN')
            owner_id = os.environ.get('OWNER_CHAT_ID')
            group_id = os.environ.get('GROUP_CHAT_ID')
            
            # Debug: Ki·ªÉm tra bi·∫øn m√¥i tr∆∞·ªùng
            print('='*60)
            print('üîç KI·ªÇM TRA BI·∫æN M√îI TR∆Ø·ªúNG')
            print('='*60)
            print(f'Bot Token: {\"‚úÖ C√≥ (\" + bot_token[:20] + \"...)\" if bot_token else \"‚ùå Kh√¥ng c√≥\"}')
            print(f'Token Length: {len(bot_token) if bot_token else 0}')
            print(f'Owner ID: {\"‚úÖ C√≥ (\" + owner_id + \")\" if owner_id else \"‚ùå Kh√¥ng c√≥\"}')
            print(f'Group ID: {\"‚úÖ C√≥ (\" + group_id + \")\" if group_id else \"‚ùå Kh√¥ng c√≥\"}')
            print('='*60)
            print()
            
            if not bot_token or not bot_token.strip():
                print('‚ùå TELEGRAM_BOT_TOKEN kh√¥ng ƒë∆∞·ª£c thi·∫øt l·∫≠p!')
                print('üí° Ki·ªÉm tra GitHub Secrets')
                return
            
            if not owner_id:
                print('‚ùå OWNER_CHAT_ID kh√¥ng ƒë∆∞·ª£c thi·∫øt l·∫≠p!')
                print('üí° Ki·ªÉm tra GitHub Secrets')
                return
            
            # Kh·ªüi t·∫°o dashboard
            print('üîÑ ƒêang l·∫•y d·ªØ li·ªáu...')
            dashboard = FearGreedDashboard()
            
            if not dashboard.fetch_data(limit=90):
                print('‚ùå Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ API')
                return
            
            print(f'‚úÖ ƒê√£ l·∫•y {len(dashboard.data)} b·∫£n ghi')
            print(f'üìä Gi√° tr·ªã: {dashboard.current_value} - {dashboard.current_classification_vi}')
            print()
            
            # T·∫°o b√°o c√°o
            print('üé® ƒêang t·∫°o b√°o c√°o...')
            report_file = 'report_temp.png'
            dashboard.create_full_report(save_path=report_file)
            
            if not os.path.exists(report_file):
                print('‚ùå Kh√¥ng th·ªÉ t·∫°o file b√°o c√°o')
                return
            
            file_size = os.path.getsize(report_file) / 1024
            print(f'‚úÖ ƒê√£ t·∫°o b√°o c√°o ({file_size:.1f} KB)')
            print()
            
            # G·ª≠i Telegram
            print('üì§ ƒêang g·ª≠i Telegram...')
            bot = Bot(token=bot_token)
            
            caption = f'''üìä **B√ÅO C√ÅO CH·ªà S·ªê T√ÇM L√ù TH·ªä TR∆Ø·ªúNG**
‚è∞ {datetime.now().strftime(\"%d/%m/%Y %H:%M\")}

**Hi·ªán t·∫°i:** {dashboard.current_value} - {dashboard.current_classification_vi}

ü§ñ T·ª± ƒë·ªông t·ª´ GitHub Actions
#FearGreed #Crypto #AutoReport'''
            
            try:
                # G·ª≠i cho owner
                with open(report_file, 'rb') as photo:
                    await bot.send_photo(
                        chat_id=owner_id,
                        photo=photo,
                        caption=caption,
                        parse_mode='Markdown'
                    )
                print(f'‚úÖ ƒê√£ g·ª≠i cho owner: {owner_id}')
                
                # G·ª≠i v√†o group n·∫øu c√≥
                if group_id and group_id != 'YOUR_GROUP_ID' and group_id.strip():
                    try:
                        with open(report_file, 'rb') as photo:
                            await bot.send_photo(
                                chat_id=group_id,
                                photo=photo,
                                caption=caption,
                                parse_mode='Markdown'
                            )
                        print(f'‚úÖ ƒê√£ g·ª≠i v√†o group: {group_id}')
                    except Exception as group_error:
                        print(f'‚ö†Ô∏è  Kh√¥ng th·ªÉ g·ª≠i v√†o group: {group_error}')
                
            except Exception as e:
                print(f'‚ùå L·ªói khi g·ª≠i: {e}')
                raise
            
            # X√≥a file t·∫°m
            os.remove(report_file)
            print('üßπ ƒê√£ d·ªçn d·∫πp file t·∫°m')
            print()
            print('='*60)
            print('üéâ HO√ÄN T·∫§T!')
            print('='*60)
        
        # Ch·∫°y async function
        asyncio.run(send_report())
        "
    
    - name: ‚úÖ Job completed
      if: success()
      run: echo "üéâ B√°o c√°o ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!"
    
    - name: ‚ùå Job failed
      if: failure()
      run: |
        echo "‚ùå C√≥ l·ªói x·∫£y ra!"
        echo "üí° Ki·ªÉm tra logs ·ªü tr√™n ƒë·ªÉ debug"