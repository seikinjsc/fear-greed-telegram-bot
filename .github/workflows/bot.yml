name: Fear & Greed Bot

on:
  # Cháº¡y theo lá»‹ch (4 láº§n/ngÃ y)
  schedule:
    - cron: '0 1,5,9,13 * * *'  # 8h, 12h, 16h, 20h (UTC+7)
  
  # Cho phÃ©p cháº¡y thá»§ cÃ´ng
  workflow_dispatch:
  
  # Cháº¡y khi push code (Ä‘á»ƒ test)
  push:
    branches: [ main ]

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ”§ Create .env file
      run: |
        echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" >> .env
        echo "OWNER_CHAT_ID=${{ secrets.OWNER_CHAT_ID }}" >> .env
        echo "GROUP_CHAT_ID=${{ secrets.GROUP_CHAT_ID }}" >> .env
    
    - name: ğŸ“Š Run report generation
      run: |
        python -c "
        from fear_greed_dashboard import FearGreedDashboard
        from telegram import Bot
        import asyncio
        import os
        from datetime import datetime
        
        async def send_report():
            # Khá»Ÿi táº¡o dashboard
            dashboard = FearGreedDashboard()
            
            # Láº¥y dá»¯ liá»‡u
            print('ğŸ”„ Äang láº¥y dá»¯ liá»‡u...')
            if not dashboard.fetch_data(limit=90):
                print('âŒ KhÃ´ng thá»ƒ láº¥y dá»¯ liá»‡u')
                return
            
            # Táº¡o bÃ¡o cÃ¡o
            print('ğŸ¨ Äang táº¡o bÃ¡o cÃ¡o...')
            report_file = 'report_temp.png'
            dashboard.create_full_report(save_path=report_file)
            
            # Gá»­i Telegram
            print('ğŸ“¤ Äang gá»­i Telegram...')
            bot_token = os.getenv('TELEGRAM_BOT_TOKEN')
            owner_id = os.getenv('OWNER_CHAT_ID')
            group_id = os.getenv('GROUP_CHAT_ID')
            
            bot = Bot(token=bot_token)
            
            caption = f'''
        ğŸ“Š **BÃO CÃO CHá»ˆ Sá» TÃ‚M LÃ THá»Š TRÆ¯á»œNG**
        â° {datetime.now().strftime('%d/%m/%Y %H:%M')}
        
        **Hiá»‡n táº¡i:** {dashboard.current_value} - {dashboard.current_classification_vi}
        
        ğŸ¤– Tá»± Ä‘á»™ng tá»« GitHub Actions
        #FearGreed #Crypto #AutoReport
        '''
            
            # Gá»­i cho owner
            with open(report_file, 'rb') as photo:
                await bot.send_photo(
                    chat_id=owner_id,
                    photo=photo,
                    caption=caption,
                    parse_mode='Markdown'
                )
            print(f'âœ… ÄÃ£ gá»­i cho owner: {owner_id}')
            
            # Gá»­i vÃ o group náº¿u cÃ³
            if group_id and group_id != 'YOUR_GROUP_ID':
                with open(report_file, 'rb') as photo:
                    await bot.send_photo(
                        chat_id=group_id,
                        photo=photo,
                        caption=caption,
                        parse_mode='Markdown'
                    )
                print(f'âœ… ÄÃ£ gá»­i vÃ o group: {group_id}')
            
            # XÃ³a file táº¡m
            os.remove(report_file)
            print('ğŸ§¹ ÄÃ£ dá»n dáº¹p file táº¡m')
        
        # Cháº¡y async function
        asyncio.run(send_report())
        "
    
    - name: âœ… Job completed
      run: echo "ğŸ‰ BÃ¡o cÃ¡o Ä‘Ã£ Ä‘Æ°á»£c gá»­i thÃ nh cÃ´ng!"