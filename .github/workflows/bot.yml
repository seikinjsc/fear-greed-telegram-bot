name: Fear & Greed Bot

on:
  # Cháº¡y theo lá»‹ch (4 láº§n/ngÃ y)
  schedule:
    - cron: '0 1,5,9,13 * * *'  # 8h, 12h, 16h, 20h (UTC+7)
  
  # Cho phÃ©p cháº¡y thá»§ cÃ´ng
  workflow_dispatch:
  
  # Cháº¡y khi push code (Ä‘á»ƒ test)
  push:
    branches: [ main ]

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
    - name: ğŸ” Debug secrets (chi tiáº¿t)
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        OWNER_CHAT_ID: ${{ secrets.OWNER_CHAT_ID }}
        GROUP_CHAT_ID: ${{ secrets.GROUP_CHAT_ID }}
      run: python debug_secrets.py
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ“Š Run report and send to Telegram
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        OWNER_CHAT_ID: ${{ secrets.OWNER_CHAT_ID }}
        GROUP_CHAT_ID: ${{ secrets.GROUP_CHAT_ID }}
      run: |
        python -c "
        import os
        import asyncio
        from datetime import datetime
        from telegram import Bot
        from fear_greed_dashboard import FearGreedDashboard
        
        async def send_report():
            # Láº¥y biáº¿n mÃ´i trÆ°á»ng
            bot_token = os.environ.get('TELEGRAM_BOT_TOKEN')
            owner_id = os.environ.get('OWNER_CHAT_ID')
            group_id = os.environ.get('GROUP_CHAT_ID')
            
            # Debug: Kiá»ƒm tra biáº¿n mÃ´i trÆ°á»ng
            print('='*60)
            print('ğŸ” KIá»‚M TRA BIáº¾N MÃ”I TRÆ¯á»œNG')
            print('='*60)
            print(f'Bot Token: {\"âœ… CÃ³ (\" + bot_token[:20] + \"...)\" if bot_token else \"âŒ KhÃ´ng cÃ³\"}')
            print(f'Token Length: {len(bot_token) if bot_token else 0}')
            print(f'Owner ID: {\"âœ… CÃ³ (\" + owner_id + \")\" if owner_id else \"âŒ KhÃ´ng cÃ³\"}')
            print(f'Group ID: {\"âœ… CÃ³ (\" + group_id + \")\" if group_id else \"âŒ KhÃ´ng cÃ³\"}')
            print('='*60)
            print()
            
            if not bot_token or not bot_token.strip():
                print('âŒ TELEGRAM_BOT_TOKEN khÃ´ng Ä‘Æ°á»£c thiáº¿t láº­p!')
                print('ğŸ’¡ Kiá»ƒm tra GitHub Secrets')
                print(f'ğŸ“Š Debug: token=\"{bot_token}\"')
                return
            
            if not owner_id:
                print('âŒ OWNER_CHAT_ID khÃ´ng Ä‘Æ°á»£c thiáº¿t láº­p!')
                print('ğŸ’¡ Kiá»ƒm tra GitHub Secrets')
                return
            
            # Khá»Ÿi táº¡o dashboard
            print('ğŸ”„ Äang láº¥y dá»¯ liá»‡u...')
            dashboard = FearGreedDashboard()
            
            if not dashboard.fetch_data(limit=90):
                print('âŒ KhÃ´ng thá»ƒ láº¥y dá»¯ liá»‡u tá»« API')
                return
            
            print(f'âœ… ÄÃ£ láº¥y {len(dashboard.data)} báº£n ghi')
            print(f'ğŸ“Š GiÃ¡ trá»‹: {dashboard.current_value} - {dashboard.current_classification_vi}')
            print()
            
            # Táº¡o bÃ¡o cÃ¡o
            print('ğŸ¨ Äang táº¡o bÃ¡o cÃ¡o...')
            report_file = 'report_temp.png'
            dashboard.create_full_report(save_path=report_file)
            
            if not os.path.exists(report_file):
                print('âŒ KhÃ´ng thá»ƒ táº¡o file bÃ¡o cÃ¡o')
                return
            
            file_size = os.path.getsize(report_file) / 1024
            print(f'âœ… ÄÃ£ táº¡o bÃ¡o cÃ¡o ({file_size:.1f} KB)')
            print()
            
            # Gá»­i Telegram
            print('ğŸ“¤ Äang gá»­i Telegram...')
            bot = Bot(token=bot_token)
            
            caption = f'''ğŸ“Š **BÃO CÃO CHá»ˆ Sá» TÃ‚M LÃ THá»Š TRÆ¯á»œNG**
â° {datetime.now().strftime(\"%d/%m/%Y %H:%M\")}

**Hiá»‡n táº¡i:** {dashboard.current_value} - {dashboard.current_classification_vi}

ğŸ¤– Tá»± Ä‘á»™ng tá»« GitHub Actions
#FearGreed #Crypto #AutoReport'''
            
            try:
                # Gá»­i cho owner
                with open(report_file, 'rb') as photo:
                    await bot.send_photo(
                        chat_id=owner_id,
                        photo=photo,
                        caption=caption,
                        parse_mode='Markdown'
                    )
                print(f'âœ… ÄÃ£ gá»­i cho owner: {owner_id}')
                
                # Gá»­i vÃ o group náº¿u cÃ³
                if group_id and group_id != 'YOUR_GROUP_ID' and group_id.strip():
                    with open(report_file, 'rb') as photo:
                        await bot.send_photo(
                            chat_id=group_id,
                            photo=photo,
                            caption=caption,
                            parse_mode='Markdown'
                        )
                    print(f'âœ… ÄÃ£ gá»­i vÃ o group: {group_id}')
                
            except Exception as e:
                print(f'âŒ Lá»—i khi gá»­i: {e}')
                raise
            
            # XÃ³a file táº¡m
            os.remove(report_file)
            print('ğŸ§¹ ÄÃ£ dá»n dáº¹p file táº¡m')
            print()
            print('='*60)
            print('ğŸ‰ HOÃ€N Táº¤T!')
            print('='*60)
        
        # Cháº¡y async function
        asyncio.run(send_report())
        "
    
    - name: âœ… Job completed
      if: success()
      run: echo "ğŸ‰ BÃ¡o cÃ¡o Ä‘Ã£ Ä‘Æ°á»£c gá»­i thÃ nh cÃ´ng!"
    
    - name: âŒ Job failed
      if: failure()
      run: |
        echo "âŒ CÃ³ lá»—i xáº£y ra!"
        echo "ğŸ’¡ Kiá»ƒm tra logs á»Ÿ trÃªn Ä‘á»ƒ debug"